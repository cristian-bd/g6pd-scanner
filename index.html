<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Scanner Codici a Barre</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        button {
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .hidden {
            display: none !important;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #scanner-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #scanner-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
            text-align: center;
        }
        
        .manual-input {
            margin-top: 20px;
            text-align: center;
        }
        
        .manual-input input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 200px;
            margin-right: 10px;
        }
        
        .focus-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        .focus-target {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid #fff;
            border-radius: 50%;
            opacity: 0;
            transform: scale(1.5);
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.3);
        }
        
        .focus-target.active {
            opacity: 1;
            transform: scale(1);
        }
        
        .focus-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 15;
        }
        
        .focus-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .focus-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .focus-btn.active {
            background: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Scanner Codici a Barre</h1>
        
        <div class="controls">
            <button id="startCameraBtn" class="btn-primary">üì∑ Avvia Scanner</button>
            <button id="stopCameraBtn" class="btn-danger hidden">‚èπÔ∏è Ferma Scanner</button>
            <button id="simulateScanBtn" class="btn-secondary">üéØ Simula Scansione</button>
        </div>
        
        <div id="cameraContainer" class="camera-container hidden">
            <div id="scanner-container"></div>
        </div>
        
        <div id="status" class="status info">üì∑ Premi "Avvia Scanner" per iniziare</div>
        
        <div class="manual-input">
            <input type="text" id="manualBarcode" placeholder="Inserisci codice manuale" pattern="[0-9]{8,13}">
            <button onclick="processManualBarcode()" class="btn-secondary">Cerca</button>
        </div>
        
        <div id="result" class="result hidden"></div>
    </div>

    <script>
        // Variabili globali
        let isScanning = false;
        let currentStream = null;
        let nativeDetector = null;
        let lastResults = [];
        let detectionTimeout = null;
        let focusCapabilities = null;
        let currentFocusMode = 'auto';
        const requiredMatches = 2; // Ridotto da 3 a 2 per maggiore reattivit√†
        const DETECTION_COOLDOWN = 1000; // Cooldown tra detection multiple

        // Event listeners
        document.getElementById('startCameraBtn').addEventListener('click', startScanner);
        document.getElementById('stopCameraBtn').addEventListener('click', stopScanner);
        document.getElementById('simulateScanBtn').addEventListener('click', simulateBarcode);

        // Utility functions
        function updateScanStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function showError(message) {
            updateScanStatus(message, 'error');
        }

        function clearError() {
            updateScanStatus('üì∑ Inquadra il codice a barre', 'info');
        }

        function showScanSuccess(code) {
            updateScanStatus(`‚úÖ Codice rilevato: ${code}`, 'success');
            // Vibrazione se supportata
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function isValidBarcode(code) {
            if (!code) return false;
            const cleanCode = String(code).trim();
            // Verifica EAN-8 o EAN-13 (solo numeri)
            return /^\d{8}$/.test(cleanCode) || /^\d{13}$/.test(cleanCode);
        }

        // Scanner principale
        async function startScanner() {
            if (isScanning) return;
            
            // Controllo sicurezza
            const isSecureContext = window.isSecureContext || 
                                   location.protocol === 'https:' || 
                                   location.hostname === 'localhost' ||
                                   location.hostname === '127.0.0.1';
            
            if (!isSecureContext) {
                showError('‚ùå Scanner camera richiede HTTPS o localhost.');
                return;
            }
            
            if (!navigator.mediaDevices?.getUserMedia) {
                showError('‚ùå Camera non supportata su questo browser/dispositivo.');
                return;
            }

            clearError();
            isScanning = true;
            lastResults = [];

            // Update UI
            document.getElementById('cameraContainer').classList.remove('hidden');
            document.getElementById('startCameraBtn').classList.add('hidden');
            document.getElementById('stopCameraBtn').classList.remove('hidden');
            document.getElementById('simulateScanBtn').classList.add('hidden');
            document.getElementById('result').classList.add('hidden');
            updateScanStatus('üì∑ Avvio camera...');

            try {
                // Determina il metodo di scansione
                const useNative = await checkNativeSupport();
                
                if (useNative) {
                    await startNativeScanner();
                } else {
                    await startQuaggaScanner();
                }
            } catch (err) {
                console.error('Errore scanner:', err);
                showError(`‚ùå Errore scanner: ${err.message}`);
                stopScanner();
            }
        }

        async function checkNativeSupport() {
            if (!window.BarcodeDetector) return false;
            
            try {
                const formats = await BarcodeDetector.getSupportedFormats();
                return formats.includes('ean_13') || formats.includes('ean_8');
            } catch (e) {
                console.warn('BarcodeDetector check failed:', e);
                return false;
            }
        }

        async function startNativeScanner() {
            console.log('üîß Usando BarcodeDetector nativo');
            
            const container = document.getElementById('scanner-container');
            container.innerHTML = ''; // Pulisci container
            
            // Crea video element
            const video = document.createElement('video');
            video.setAttribute('playsinline', '');
            video.setAttribute('muted', '');
            video.autoplay = true;
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'cover';
            container.appendChild(video);

            // Crea overlay per controlli focus
            createFocusOverlay(container);

            // Ottieni stream camera con constraints ottimizzati per barcode
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" },
                    width: { min: 640, ideal: 1280, max: 1920 },
                    height: { min: 480, ideal: 720, max: 1080 },
                    // Constraints per autofocus ottimizzato
                    focusMode: { ideal: "continuous" },
                    focusDistance: { ideal: 0 }, // Per macro/close-up
                    exposureMode: { ideal: "continuous" },
                    whiteBalanceMode: { ideal: "continuous" }
                },
                audio: false
            });
            
            video.srcObject = currentStream;
            await video.play();

            // Setup controlli focus avanzati
            await setupAdvancedFocus(video);

            // Inizializza detector
            nativeDetector = new BarcodeDetector({ 
                formats: ['ean_13', 'ean_8'] 
            });
            
            updateScanStatus('üì∑ Scanner attivo (nativo) - tocca per mettere a fuoco');
            runNativeDetectionLoop(video);
        }

        function runNativeDetectionLoop(video) {
            if (!isScanning || !nativeDetector) return;

            const detect = async () => {
                if (!isScanning) return;
                
                try {
                    const barcodes = await nativeDetector.detect(video);
                    
                    if (barcodes?.length > 0) {
                        for (const barcode of barcodes) {
                            const code = barcode.rawValue;
                            if (isValidBarcode(code)) {
                                processDetectedCode(code);
                                break; // Prendi solo il primo valido
                            }
                        }
                    }
                } catch (err) {
                    console.warn('Native detection error:', err);
                }
                
                if (isScanning) {
                    // Usa setTimeout invece di requestAnimationFrame per controllo timing
                    setTimeout(detect, 100);
                }
            };
            
            detect();
        }

        async function startQuaggaScanner() {
            console.log('üîß Usando Quagga fallback');
            
            updateScanStatus('üì∑ Inizializzazione scanner...');
            
            // Cleanup precedenti listeners
            try {
                if (window.Quagga) {
                    Quagga.offDetected();
                    Quagga.offProcessed();
                }
            } catch (e) {
                console.warn('Quagga cleanup error:', e);
            }

            return new Promise((resolve, reject) => {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner-container'),
                        constraints: {
                            width: { min: 640, ideal: 1280 },
                            height: { min: 480, ideal: 720 },
                            facingMode: "environment",
                            // Constraints focus per Quagga
                            focusMode: { ideal: "continuous" },
                            focusDistance: { ideal: 0 },
                            exposureMode: { ideal: "continuous" }
                        }
                    },
                    locator: {
                        patchSize: "large",
                        halfSample: false,
                        debug: {
                            showCanvas: false,
                            showPatches: false,
                            showFoundPatches: false,
                            showSkeleton: false,
                            showLabels: false,
                            showPatchLabels: false,
                            showRemainingPatchLabels: false,
                            boxFromPatches: {
                                showTransformed: false,
                                showTransformedBox: false,
                                showBB: false
                            }
                        }
                    },
                    numOfWorkers: Math.min(2, navigator.hardwareConcurrency || 2),
                    frequency: 10,
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader"],
                        debug: {
                            drawBoundingBox: false,
                            showFrequency: false,
                            drawScanline: false,
                            showPattern: false
                        }
                    },
                    locate: true
                }, async (err) => {
                    if (err) {
                        console.error('Quagga init error:', err);
                        reject(err);
                        return;
                    }
                    
                    Quagga.start();
                    
                    // Setup focus per Quagga
                    const container = document.querySelector('#scanner-container');
                    const video = container.querySelector('video');
                    if (video) {
                        createFocusOverlay(container);
                        await setupAdvancedFocus(video);
                    }
                    
                    updateScanStatus('üì∑ Scanner attivo (fallback) - tocca per mettere a fuoco');
                    
                    // Setup listeners
                    Quagga.onDetected(handleQuaggaDetection);
                    
                    resolve();
                });
            });
        }

        function handleQuaggaDetection(data) {
            try {
                const code = data?.codeResult?.code;
                if (isValidBarcode(code)) {
                    processDetectedCode(code);
                }
            } catch (e) {
                console.warn('Quagga detection handler error:', e);
            }
        }

        function processDetectedCode(code) {
            if (detectionTimeout) return; // Prevent spam detection
            
            lastResults.push(code);
            if (lastResults.length > requiredMatches) {
                lastResults.shift();
            }
            
            // Controlla se abbiamo abbastanza match consistenti
            const isConsistent = lastResults.length >= requiredMatches && 
                                lastResults.every(c => c === lastResults[0]);
            
            if (isConsistent) {
                console.log('‚úÖ Codice confermato:', code);
                showScanSuccess(code);
                
                // Cooldown per evitare detection multiple
                detectionTimeout = setTimeout(() => {
                    detectionTimeout = null;
                }, DETECTION_COOLDOWN);
                
                // Ferma scanner e processa
                setTimeout(() => {
                    stopScanner();
                    searchProductByBarcode(code);
                }, 800);
                
                lastResults = [];
            } else {
                updateScanStatus(`üîç Rilevamento: ${code} (${lastResults.length}/${requiredMatches})`);
            }
        }

        function stopScanner() {
            console.log('üõë Fermando scanner...');
            
            if (!isScanning && !currentStream) {
                // Solo update UI
                updateUI(false);
                return;
            }
            
            isScanning = false;
            lastResults = [];
            
            if (detectionTimeout) {
                clearTimeout(detectionTimeout);
                detectionTimeout = null;
            }

            // Stop native detector
            nativeDetector = null;

            // Stop Quagga
            try {
                if (window.Quagga) {
                    Quagga.offDetected();
                    Quagga.offProcessed();
                    if (typeof Quagga.stop === 'function') {
                        Quagga.stop();
                    }
                }
            } catch (e) {
                console.warn('Errore stop Quagga:', e);
            }

            // Stop media stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                });
                currentStream = null;
            }

            // Clean container
            const container = document.getElementById('scanner-container');
            if (container) {
                container.innerHTML = '';
            }

            updateUI(false);
            updateScanStatus('üì∑ Premi "Avvia Scanner" per iniziare');
        }

        function updateUI(scanning) {
            const elements = {
                cameraContainer: document.getElementById('cameraContainer'),
                startBtn: document.getElementById('startCameraBtn'),
                stopBtn: document.getElementById('stopCameraBtn'),
                simulateBtn: document.getElementById('simulateScanBtn')
            };
            
            if (scanning) {
                elements.cameraContainer?.classList.remove('hidden');
                elements.startBtn?.classList.add('hidden');
                elements.stopBtn?.classList.remove('hidden');
                elements.simulateBtn?.classList.add('hidden');
            } else {
                elements.cameraContainer?.classList.add('hidden');
                elements.startBtn?.classList.remove('hidden');
                elements.stopBtn?.classList.add('hidden');
                elements.simulateBtn?.classList.remove('hidden');
            }
        }

        // Test functions
        function simulateBarcode() {
            const testCodes = ['8001234567890', '12345678'];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            
            updateScanStatus(`üéØ Simulazione: ${randomCode}`, 'success');
            setTimeout(() => searchProductByBarcode(randomCode), 1000);
        }

        function processManualBarcode() {
            const input = document.getElementById('manualBarcode');
            const code = input.value.trim();
            
            if (!isValidBarcode(code)) {
                showError('‚ùå Inserisci un codice EAN-8 o EAN-13 valido (solo numeri)');
                return;
            }
            
            input.value = '';
            updateScanStatus(`‚úÖ Codice inserito: ${code}`, 'success');
            setTimeout(() => searchProductByBarcode(code), 500);
        }

        function searchProductByBarcode(barcode) {
            const resultEl = document.getElementById('result');
            resultEl.innerHTML = `
                <h3>üîç Risultato Ricerca</h3>
                <p><strong>Codice:</strong> ${barcode}</p>
                <p><strong>Lunghezza:</strong> ${barcode.length} cifre</p>
                <p><strong>Tipo:</strong> ${barcode.length === 8 ? 'EAN-8' : 'EAN-13'}</p>
                <p><em>Qui implementeresti la chiamata alle API per cercare il prodotto...</em></p>
            `;
            resultEl.classList.remove('hidden');
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isScanning) {
                console.log('üì± Pagina nascosta, fermando scanner');
                stopScanner();
            }
        });

        // Prevent form submission on Enter
        document.getElementById('manualBarcode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                processManualBarcode();
            }
        });
        
        console.log('üöÄ Scanner Barcode inizializzato');

        // Funzioni per gestione focus avanzato
        function createFocusOverlay(container) {
            // Crea overlay per focus visivo
            const overlay = document.createElement('div');
            overlay.className = 'focus-overlay';
            overlay.innerHTML = '<div class="focus-target" id="focusTarget"></div>';
            
            // Crea controlli focus
            const controls = document.createElement('div');
            controls.className = 'focus-controls';
            controls.innerHTML = `
                <button class="focus-btn active" onclick="setFocusMode('auto')">üéØ Auto</button>
                <button class="focus-btn" onclick="setFocusMode('macro')">üîç Macro</button>
                <button class="focus-btn" onclick="setFocusMode('infinity')">üèîÔ∏è Infinito</button>
                <button class="focus-btn" onclick="triggerFocus()">üì∑ Focus</button>
            `;
            
            overlay.appendChild(controls);
            container.appendChild(overlay);
            
            // Aggiungi listener per tap-to-focus
            container.addEventListener('click', handleTapToFocus);
            container.style.cursor = 'crosshair';
        }

        async function setupAdvancedFocus(video) {
            if (!currentStream) return;
            
            const videoTrack = currentStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            try {
                focusCapabilities = videoTrack.getCapabilities();
                console.log('üì∑ Capacit√† focus disponibili:', focusCapabilities);
                
                // Applica impostazioni focus ottimali per barcode
                const constraints = {};
                
                // Focus mode
                if (focusCapabilities.focusMode?.includes('continuous-autofocus')) {
                    constraints.focusMode = 'continuous-autofocus';
                } else if (focusCapabilities.focusMode?.includes('single-shot')) {
                    constraints.focusMode = 'single-shot';
                }
                
                // Focus distance per macro (codici a barre da vicino)
                if (focusCapabilities.focusDistance) {
                    constraints.focusDistance = 0.1; // Vicino per barcode
                }
                
                // Exposure per migliorare contrasto
                if (focusCapabilities.exposureMode?.includes('continuous')) {
                    constraints.exposureMode = 'continuous';
                }
                
                // White balance
                if (focusCapabilities.whiteBalanceMode?.includes('continuous')) {
                    constraints.whiteBalanceMode = 'continuous';
                }
                
                await videoTrack.applyConstraints({ advanced: [constraints] });
                console.log('‚úÖ Constraints focus applicati:', constraints);
                
                // Auto-focus periodico per mantenere la nitidezza
                startPeriodicFocus(videoTrack);
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Errore setup focus avanzato:', error);
                // Fallback a focus base
                await setupBasicFocus(videoTrack);
            }
        }

        async function setupBasicFocus(videoTrack) {
            try {
                const basicConstraints = {
                    focusMode: 'continuous-autofocus'
                };
                await videoTrack.applyConstraints({ advanced: [basicConstraints] });
                console.log('‚úÖ Focus base applicato');
            } catch (error) {
                console.warn('‚ö†Ô∏è Anche il focus base ha fallito:', error);
            }
        }

        function startPeriodicFocus(videoTrack) {
            // Auto-focus ogni 5 secondi per mantenere nitidezza
            const focusInterval = setInterval(async () => {
                if (!isScanning || !videoTrack) {
                    clearInterval(focusInterval);
                    return;
                }
                
                try {
                    if (focusCapabilities?.focusMode?.includes('single-shot')) {
                        await videoTrack.applyConstraints({
                            advanced: [{ focusMode: 'single-shot' }]
                        });
                        // Torna a continuous dopo un momento
                        setTimeout(async () => {
                            if (isScanning) {
                                await videoTrack.applyConstraints({
                                    advanced: [{ focusMode: 'continuous-autofocus' }]
                                });
                            }
                        }, 500);
                    }
                } catch (error) {
                    console.warn('Auto-focus periodico fallito:', error);
                }
            }, 5000);
        }

        async function handleTapToFocus(event) {
            if (!currentStream || !isScanning) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Mostra indicatore focus
            const focusTarget = document.getElementById('focusTarget');
            if (focusTarget) {
                focusTarget.style.left = (x - 30) + 'px';
                focusTarget.style.top = (y - 30) + 'px';
                focusTarget.classList.add('active');
                
                setTimeout(() => {
                    focusTarget.classList.remove('active');
                }, 1000);
            }
            
            // Esegui focus
            await triggerFocusAtPoint(x / rect.width, y / rect.height);
            
            // Vibrazione feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        async function triggerFocusAtPoint(x, y) {
            if (!currentStream) return;
            
            const videoTrack = currentStream.getVideoTracks()[0];
            if (!videoTrack || !focusCapabilities) return;
            
            try {
                // Se supporta point focus, usalo
                if (focusCapabilities.pointsOfInterest) {
                    await videoTrack.applyConstraints({
                        advanced: [{
                            pointsOfInterest: [{ x: x, y: y }],
                            focusMode: 'single-shot'
                        }]
                    });
                } else {
                    // Altrimenti trigger focus normale
                    await videoTrack.applyConstraints({
                        advanced: [{ focusMode: 'single-shot' }]
                    });
                }
                
                console.log(`üìç Focus triggered at (${x.toFixed(2)}, ${y.toFixed(2)})`);
                
            } catch (error) {
                console.warn('Errore tap-to-focus:', error);
            }
        }

        async function setFocusMode(mode) {
            if (!currentStream) return;
            
            const videoTrack = currentStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            currentFocusMode = mode;
            
            // Update UI
            document.querySelectorAll('.focus-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            try {
                let constraints = {};
                
                switch(mode) {
                    case 'auto':
                        constraints.focusMode = 'continuous-autofocus';
                        if (focusCapabilities?.focusDistance) {
                            constraints.focusDistance = 0.1; // Ottimale per barcode
                        }
                        break;
                    case 'macro':
                        constraints.focusMode = 'single-shot';
                        if (focusCapabilities?.focusDistance) {
                            constraints.focusDistance = 0.05; // Molto vicino
                        }
                        break;
                    case 'infinity':
                        constraints.focusMode = 'single-shot';
                        if (focusCapabilities?.focusDistance) {
                            constraints.focusDistance = 1.0; // Lontano
                        }
                        break;
                }
                
                await videoTrack.applyConstraints({ advanced: [constraints] });
                console.log(`üéØ Focus mode: ${mode}`, constraints);
                
                updateScanStatus(`üéØ Modalit√† focus: ${mode.toUpperCase()}`);
                
            } catch (error) {
                console.warn(`Errore cambio focus mode ${mode}:`, error);
                showError(`‚ùå Modalit√† focus ${mode} non supportata`);
            }
        }

        async function triggerFocus() {
            if (!currentStream) return;
            
            const videoTrack = currentStream.getVideoTracks()[0];
            if (!videoTrack) return;
            
            try {
                // Trigger single-shot focus
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'single-shot' }]
                });
                
                updateScanStatus('üì∑ Focus in corso...');
                
                // Vibrazione feedback
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                
                // Torna alla modalit√† precedente dopo un momento
                setTimeout(async () => {
                    if (isScanning && currentFocusMode === 'auto') {
                        await videoTrack.applyConstraints({
                            advanced: [{ focusMode: 'continuous-autofocus' }]
                        });
                    }
                    updateScanStatus('üì∑ Scanner attivo - tocca per mettere a fuoco');
                }, 1000);
                
            } catch (error) {
                console.warn('Errore trigger focus:', error);
                showError('‚ùå Focus manuale fallito');
            }
        }
    </script>
</body>
</html>
